<!DOCTYPE html> <html lang=" en "><head> <meta charset="utf-8"> <title>Wilson Fok - A data science enthusiast</title> <meta http-equip="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="description" content="Learning object detection part 4 - network results and discussion" /> <meta name="keywords" content="Learning object detection part 4 - network results and discussion, Wilson Fok, Deep_Learning" /> <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml"> <meta content="" property="fb:app_id"> <meta content="Wilson Fok" property="og:site_name"> <meta content="Learning object detection part 4 - network results and discussion" property="og:title"> <meta content="article" property="og:type"> <meta content="Object detection results and discussion" property="og:description"> <meta content="/deep_learning/2020/08/02/Learning_Object_Detection_part4/" property="og:url"> <meta content="2020-08-02T00:00:00+08:00" property="article:published_time"> <meta content="/about/" property="article:author"> <meta content="Deep_Learning" property="article:section"> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@"> <meta name="twitter:creator" content="@"> <meta name="twitter:title" content="Learning object detection part 4 - network results and discussion"> <meta content="Wilson Fok" property="og:site_name"> <meta name="twitter:url" content="/deep_learning/2020/08/02/Learning_Object_Detection_part4/"> <meta name="twitter:description" content="Hello, My name is Wilson Fok. I love to extract useful insights and knowledge from big data. I also like to make new friends and connections. Let's connect! "> <!-- load layout style css --> <link rel="stylesheet" href="/assets/css/main.css" /> <link rel="stylesheet" href="/assets/css/custom-style.css" /> <link rel="stylesheet" href="/assets/bower_components/lightgallery/dist/css/lightgallery.min.css"/> <link rel="stylesheet" href="/assets/bower_components/bootstrap/dist/css/bootstrap.min.css" /> <link rel="stylesheet" href="/assets/bower_components/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" /> <!-- Favicon --> <link rel="icon" href="/assets/img/favicon.ico" type="image/gif" sizes="16x16"> <!-- Jquery --> <!-- one or more of the below scripts does fancy word animation and dropdown menu --> <script src="/assets/extra_js/jquery-3.4.1.min.js"></script> <script src="/assets/extra_js/picturefill min/picturefill.min.js"></script> <script src="/assets/extra_js/instantsearch min/instantsearch.min.js"></script> <script src="/assets/extra_js/moment min/moment.min.js"></script> <script src="/assets/bower_components/jquery.easing/jquery.easing.min.js"></script> <script src="/assets/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script> <script src="/assets/bower_components/jquery-mousewheel/jquery.mousewheel.min.js"></script> <script src="/assets/bower_components/lightgallery/dist/js/lightgallery-all.min.js"></script> <script src="/assets/bower_components/imagesloaded/imagesloaded.pkgd.min.js"></script> <script src="/assets/bower_components/nanobar/nanobar.min.js"></script> <script src="/assets/bower_components/typewrite/dist/typewrite.min.js"></script> </head><body> <div class="container-fluid"><header> <div class="col-lg-12"> <div class="row"> <nav class="navbar navbar-expand-lg fixed-top navbar-dark " id="topNav"> <!-- <a class="navbar-brand" href="#">Wilson Fok</a> --> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="/">Wilson Fok</a> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav"> <li class="nav-item"> <a class="nav-link" href="/about">About Me</a> </li> <li class="nav-item"> <a class="nav-link" href="/blog">Blog</a> </li> <li class="nav-item"> <a class="nav-link" href="/blog/categories">Categories</a> </li> <li class="nav-item"> <a class="nav-link" href="/contact">Contact Me</a> </li> </ul> </div> <ul class="nav justify-content-end"> <!-- <li class="nav-item"> <a class="nav-link" id="search-icon" href="/search/"><i class="fa fa-search" aria-hidden="true"></i></a> </li> --> <li class="nav-item"> <input class="nav-link switch" id="theme-toggle" onclick="modeSwitcher() "type="checkbox" name="checkbox" > </li> </ul> </nav> </div> </div> </header><div class="col-lg-12"> <!-- Blog Post Breadcrumbs --><div class="col-lg-12"> <nav aria-label="breadcrumb" role="navigation"> <ol class="breadcrumb"> <li class="breadcrumb-item"> <a href="/blog"><i class="fa fa-home" aria-hidden="true"></i></a> </li> <li class="breadcrumb-item active" aria-current="page"><a href="/deep_learning/2020/08/02/Learning_Object_Detection_part4/">Learning object detection part 4 - network results and discussion</a></li> </ol> </nav> </div><div class="row" id="blog-post-container"> <div class="col-lg-8 offset-md-2"><article class="card" itemscope itemtype="http://schema.org/BlogPosting"> <div class="card-header"> <h1 class="post-title" itemprop="name headline">Learning object detection part 4 - network results and discussion</h1> <p></p> <h6 class="post-meta"> <i> Summary : Object detection results and discussion</i> </h6> <p class="post-summary">Posted by : <img src="/assets/img/profile.png" class="author-profile-img"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name">Wilson Fok</span> </span> on <time datetime="2020-08-02 00:00:00 +0800" itemprop="datePublished">Aug 2, 2020</time> </p> <span class="disqus-comment-count" data-disqus-identifier="/deep_learning/2020/08/02/Learning_Object_Detection_part4/"></span> <div class="post-categories"> Category : <a href="/blog/categories/Deep_Learning">Deep_Learning</a> </div> </div> <div class="card-body" itemprop="articleBody"> <h3 id="model-training-and-testing">Model training and testing</h3> <p>Generally speaking, there is nothing special in how I have trained and tested the models. Because the toy problem is so simple that there is hardly any need to do much fine-tuning or hyper-parameter search. However, I have used two separate models, namely RetinaNet to detect shapes and a small classifier model to identify colors of the shapes.</p> <p>The RetinaNet and color classifier are trained in series. First, RetinaNet proposes detected boxes which are verified to see if the confidence scores of the boxes exceed a threshold and to see if the boxes overlap with the ground truth sufficiently. I chose these two criteria to ensure the training of the color classifier could go smoothly.</p> <p>Once the detected boxes met the criteria, the patches denoted by the boxes are cropped out from the entire image. I have used these patches to train the color classifier. The reason is twofold. A patch is smaller than the image, so training becomes faster and easier. The color is independent to the size of object. Cropping the object out and resizing them to a fixed dimension make the process more efficient.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CONFIDENCE</span> <span class="o">=</span> <span class="mf">1e-4</span> <span class="c1"># have enough confidence on the detected bounding boxes to crop out patches to train a classifier
</span><span class="n">IMG_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="mi">32</span><span class="p">)</span> <span class="c1"># cropped image size, classifier input dimension
</span><span class="n">MIN_CONFIDENCE</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">IOUTHRESHOLD</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># overlap 50% or more
</span><span class="n">FREQ</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># check patch frequency
</span>
<span class="k">def</span> <span class="nf">locate_good_boxes</span><span class="p">(</span><span class="n">boxes_class</span><span class="p">):</span>
    
    <span class="s">'''
    find good enough detected boxes and to crop patches out from images to train
    a classifier
    '''</span>
    
    <span class="n">top_boxes</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="s">'''
    maybe able to add a rule that resamples the boxes to give a more balanced dataset
    '''</span>
    
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">box_scores</span> <span class="ow">in</span> <span class="n">boxes_class</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">box_scores</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># score, bbox = box_score
</span>            <span class="n">sorted_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">box_scores</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">MIN_CONFIDENCE</span><span class="p">]</span>
            
            <span class="n">top_boxes</span> <span class="o">+=</span> <span class="n">sorted_scores</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_boxes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">top_boxes</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">scores_min_bar_test</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">scores</span> <span class="o">&gt;</span> <span class="n">CONFIDENCE</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">idxs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">find_enough_overlap</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">shape_gt</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">classification</span><span class="p">,</span> <span class="n">transformed_anchors</span><span class="p">,</span> <span class="n">labels_meaning</span><span class="p">,</span> <span class="n">per_label</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    
    <span class="s">'''
    find the overlap between ground truth boxes and detected boxes
    assign the ground truth class label to the detected bounding boxes for classifier
    
    per_label is a special case used during validation / testing
    '''</span>
    
    <span class="n">boxes_class</span> <span class="o">=</span> <span class="n">pair_up_bbox_color_labels</span><span class="p">(</span><span class="n">idxs</span><span class="p">,</span> <span class="n">classification</span><span class="p">,</span> <span class="n">transformed_anchors</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">labels_meaning</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">per_label</span><span class="p">:</span>
        <span class="n">top_boxes</span> <span class="o">=</span> <span class="n">locate_top_boxes</span><span class="p">(</span><span class="n">boxes_class</span><span class="p">)</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">a_key</span> <span class="o">=</span> <span class="n">put_anchor_boxes_per_label_array</span><span class="p">(</span><span class="n">top_boxes</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">locate_good_boxes</span><span class="p">(</span><span class="n">boxes_class</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">intersection</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">ratio</span> <span class="o">=</span> <span class="n">calc_iou</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span> <span class="n">return_intersection</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">per_label</span><span class="p">:</span>
            <span class="c1"># dictionary like this makes debugging far easier
</span>            <span class="n">b_shape_dict_col_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">labels_meaning</span><span class="p">[</span><span class="n">item</span><span class="p">]:</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shape_gt</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">])}</span>
            
            <span class="n">good_overlapped_boxes</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">bbox</span><span class="p">)</span> <span class="ow">in</span> <span class="n">top_boxes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">shape_col</span> <span class="o">=</span> <span class="n">b_shape_dict_col_indices</span><span class="p">[</span><span class="n">shape</span><span class="p">]</span>
                <span class="n">row_index</span> <span class="o">=</span> <span class="n">a_key</span><span class="p">[</span><span class="n">shape</span><span class="p">]</span>
                
                <span class="n">r</span> <span class="o">=</span> <span class="n">ratio</span><span class="p">[</span><span class="n">row_index</span><span class="p">,</span> <span class="n">shape_col</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;=</span> <span class="n">IOUTHRESHOLD</span><span class="p">:</span>
                    <span class="n">good_overlapped_boxes</span><span class="p">[</span><span class="n">shape</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">bbox</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="p">(</span><span class="s">'insufficent overlap for shape </span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span><span class="n">shape</span><span class="p">)</span>
                    
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">good_overlapped_boxes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">good_overlapped_boxes</span>
        <span class="k">else</span><span class="p">:</span>
            
            <span class="c1"># pytorch likes named tuple, therefore it is so python friendly
</span>            <span class="n">max_intersection</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="nb">max</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">max_areas</span> <span class="o">=</span> <span class="n">max_intersection</span><span class="o">.</span><span class="n">values</span>
            <span class="n">max_indices</span> <span class="o">=</span> <span class="n">max_intersection</span><span class="o">.</span><span class="n">indices</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">max_areas</span> <span class="o">&gt;=</span> <span class="n">IOUTHRESHOLD</span>
            <span class="n">big_enough_predicted_boxes</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">big_enough_inputs</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            
            <span class="s">'''
            sometimes when all detected boxes fall onto a single object,
            it may use the wrong label as it just assigns the same label for all
            '''</span>
            
            <span class="k">return</span> <span class="n">big_enough_predicted_boxes</span><span class="p">,</span> <span class="n">big_enough_inputs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    
<span class="k">def</span> <span class="nf">prepare_patches</span><span class="p">(</span><span class="n">big_enough_predicted_boxes</span><span class="p">,</span> <span class="n">big_eough_inputs</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">img_copied</span><span class="p">,</span>
                    <span class="n">shape_color_dict</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="c1"># make sure datatype is correct
</span>    <span class="n">big_enough_predicted_boxes</span> <span class="o">=</span> <span class="n">big_enough_predicted_boxes</span><span class="o">.</span><span class="nb">long</span><span class="p">()</span>
    <span class="n">big_enough_predicted_boxes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">big_enough_predicted_boxes</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">y_start</span> <span class="o">=</span> <span class="n">big_enough_predicted_boxes</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">y_end</span> <span class="o">=</span> <span class="n">big_enough_predicted_boxes</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">x_start</span> <span class="o">=</span> <span class="n">big_enough_predicted_boxes</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x_end</span> <span class="o">=</span> <span class="n">big_enough_predicted_boxes</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
    
    <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">big_enough_predicted_boxes</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">L</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">temp_img_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">label_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="p">):</span>
            <span class="c1"># may not always follow the same sequence, can contain skips
</span>            <span class="k">if</span> <span class="n">shape_color_dict</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">big_eough_inputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">color</span><span class="p">,</span> <span class="n">which</span> <span class="o">=</span> <span class="n">shape_color_dict</span><span class="p">[</span><span class="n">shape</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">which</span> <span class="o">=</span> <span class="n">big_eough_inputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                
            <span class="n">temp_img</span> <span class="o">=</span> <span class="n">img_copied</span><span class="p">[</span><span class="n">which</span><span class="p">,</span> 
                                  <span class="p">:,</span>
                                  <span class="n">y_start</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span><span class="n">y_end</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                                  <span class="n">x_start</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span><span class="n">x_end</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
            
            <span class="c1"># try not to do interpolation on gpu, it can take up too much memory
</span>            <span class="n">temp_img</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">temp_img</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="n">patch</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">temp_img</span><span class="p">,</span> <span class="n">IMG_SIZE</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">temp_img_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">shape_color_dict</span><span class="p">:</span>
                <span class="n">label_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">inverse_color_labels</span><span class="p">[</span><span class="n">color</span><span class="p">]])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">big_eough_inputs</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                
        <span class="k">return</span> <span class="n">temp_img_list</span><span class="p">,</span> <span class="n">label_list</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">'no patches'</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">cat_N_items</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">copy_reorganize_inputs</span><span class="p">(</span><span class="n">annot</span><span class="p">,</span> <span class="n">color_label_gt</span><span class="p">,</span> <span class="n">img_gpu</span><span class="p">):</span>
    
    <span class="n">b</span> <span class="o">=</span> <span class="n">annot</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">color_label_gt</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">shape_gt</span> <span class="o">=</span> <span class="n">annot</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    
    <span class="c1"># repeat 123 = 111222333
</span>    <span class="n">img_copied</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">img_gpu</span><span class="p">,</span> <span class="n">annot</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">shape_gt</span><span class="p">,</span> <span class="n">img_copied</span>

<span class="k">def</span> <span class="nf">check_validity_predicted_bboxes</span><span class="p">(</span><span class="n">img_gpu</span><span class="p">,</span> <span class="n">annot</span><span class="p">,</span> <span class="n">color_label_gt</span><span class="p">,</span> <span class="n">retinanet</span><span class="p">,</span> <span class="n">iter_num</span><span class="p">):</span>
    <span class="k">print</span> <span class="p">(</span><span class="s">'iter num </span><span class="si">%</span><span class="s">d: check_validity_predicted_bboxes'</span> <span class="o">%</span><span class="n">iter_num</span><span class="p">)</span>
    

    <span class="n">retinanet</span><span class="o">.</span><span class="n">calculate_focalLoss</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">retinanet</span><span class="o">.</span><span class="nb">eval</span><span class="p">()</span>
    
    <span class="n">patches</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1"># default value 
</span>    
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">img_gpu</span><span class="p">,</span> <span class="n">annot</span><span class="p">,</span> <span class="n">color_label_gt</span> <span class="o">=</span> <span class="n">cat_N_items</span><span class="p">([</span><span class="n">img_gpu</span><span class="p">,</span> <span class="n">annot</span><span class="p">,</span> <span class="n">color_label_gt</span><span class="p">])</span>
        <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">shape_gt</span><span class="p">,</span> <span class="n">img_copied</span> <span class="o">=</span> <span class="n">copy_reorganize_inputs</span><span class="p">(</span><span class="n">annot</span><span class="p">,</span> <span class="n">color_label_gt</span><span class="p">,</span> <span class="n">img_gpu</span><span class="p">)</span>
        
        <span class="n">scores</span><span class="p">,</span> <span class="n">classification</span><span class="p">,</span> <span class="n">transformed_anchors</span> <span class="o">=</span> <span class="n">retinanet</span><span class="p">(</span><span class="n">img_gpu</span><span class="o">.</span><span class="n">cuda</span><span class="p">())</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">classification</span> <span class="o">=</span> <span class="n">classification</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">transformed_anchors</span> <span class="o">=</span> <span class="n">transformed_anchors</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        
        <span class="n">idxs</span> <span class="o">=</span> <span class="n">scores_min_bar_test</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idxs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">found</span> <span class="o">=</span> <span class="n">find_enough_overlap</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">shape_gt</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">classification</span><span class="p">,</span> 
                                        <span class="n">transformed_anchors</span><span class="p">,</span> <span class="n">labels_meaning</span><span class="p">,</span> <span class="n">per_label</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">big_enough_predicted_boxes</span><span class="p">,</span> <span class="n">big_enough_inputs</span> <span class="o">=</span> <span class="n">found</span>
                <span class="n">patches</span> <span class="o">=</span> <span class="n">prepare_patches</span><span class="p">(</span><span class="n">big_enough_predicted_boxes</span><span class="p">,</span> <span class="n">big_enough_inputs</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">img_copied</span><span class="p">)</span>
    
    <span class="n">retinanet</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

    
    <span class="k">return</span> <span class="n">patches</span>
</code></pre></div></div> <p>From my experience, the color classifier had a delay in beginning its training because it took a few epochs for the RetinaNet to produce good enough detected boxes that overlap with the objects</p> <p><img src="/assets/images/toy/train_test_plots.png" alt="Picture description" width="1100px" /></p> <center> train and validation / testing results </center> <p></p> <p>The classification_color_loss is cross entropy loss; classification loss is focal loss. Correct_per is the percentage of colors correctly identified. Regression loss is the square of the distances between the ground truth bounding boxes and the detected boxes. The task seems trivial to the network so the loss reduces exponentially and the average precision of the shape rises to 100% (within 50 epochs).</p> <p><img src="/assets/images/toy/results/bbox.png" alt="Picture description" width="1100px" /></p> <center>Detected bounding boxes. Interestingly when the object sits at the image border, with half of its body being outside of the field of view, the network misses it. </center> <p></p> <h3 id="evaluation-metrics">Evaluation metrics</h3> <p>Object detection uses mean average precision (mAP). I have adapted the algorithm for calculating <a href="https://github.com/rafaelpadilla/Object-Detection-Metrics">mAP</a>.</p> <p>Classification uses F1 scores, precision, recall, accuracy etc. I have used sklearn and matplotlib to do the calculation and plotting.</p> <p><img src="/assets/images/toy/results/metrics.png" alt="Picture description" width="1100px" /></p> <center>AP for shapes and confusion matrix for color classification during testing</center> <p></p> <h3 id="final-comments">Final comments</h3> <p>I have recently come across this paper <a href="https://arxiv.org/pdf/1911.09070.pdf">EfficientDet: Scalable and Efficient Object Detection</a>. My key takeaway is that it is beneficial to do more feature pyramid like processing in up- and down- directions and to combine feature maps across adjacent scale using learnable weightings. It is termed BiFPN. Some minor modification of the official implementation must be made because the dimension of the input samples of the toy dataset isn’t the same as the author’s dataset or in the power of 2. This cause dimension mismatch across the feature maps. My experience shows that there is little difference at all for this task. Understandably, this task is so trivial and easy to perform very well by RetinaNet.</p> <p><img src="/assets/images/toy/models/biFPN.png" alt="Picture description" height="2100px" /></p> <center>BiFPN</center> <p></p> <p><img src="/assets/images/toy/models/with_biFPN.png" alt="Picture description" height="2100px" /></p> <center>Detector with BiFPN</center> <p></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">torch</span>



<span class="k">class</span> <span class="nc">ConvBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_channels</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ConvBlock</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">num_channels</span><span class="p">,</span> <span class="n">num_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">num_channels</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">num_channels</span><span class="p">,</span> <span class="n">num_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">num_features</span><span class="o">=</span><span class="n">num_channels</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9997</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">4e-5</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BiFPN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_channels</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BiFPN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">epsilon</span>
        <span class="c1"># Conv layers
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">conv6_up</span> <span class="o">=</span> <span class="n">ConvBlock</span><span class="p">(</span><span class="n">num_channels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv5_up</span> <span class="o">=</span> <span class="n">ConvBlock</span><span class="p">(</span><span class="n">num_channels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv4_up</span> <span class="o">=</span> <span class="n">ConvBlock</span><span class="p">(</span><span class="n">num_channels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv3_up</span> <span class="o">=</span> <span class="n">ConvBlock</span><span class="p">(</span><span class="n">num_channels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv4_down</span> <span class="o">=</span> <span class="n">ConvBlock</span><span class="p">(</span><span class="n">num_channels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv5_down</span> <span class="o">=</span> <span class="n">ConvBlock</span><span class="p">(</span><span class="n">num_channels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv6_down</span> <span class="o">=</span> <span class="n">ConvBlock</span><span class="p">(</span><span class="n">num_channels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv7_down</span> <span class="o">=</span> <span class="n">ConvBlock</span><span class="p">(</span><span class="n">num_channels</span><span class="p">)</span>

        <span class="c1"># Feature scaling layers
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">p6_upsample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'nearest'</span><span class="p">)</span>
<span class="c1">#        self.p5_upsample = nn.Upsample(scale_factor=2, mode='nearest')
</span>        <span class="s">'''
        becuase the toy dataset sample size is not the same as the paper,
        we need to change the upsampling method to make sure the feature 
        maps can be concatenated.
        
        
        
        '''</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p5_upsample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">((</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s">'nearest'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p4_upsample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'nearest'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p3_upsample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'nearest'</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p4_downsample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p5_downsample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">#        self.p6_downsample = nn.MaxPool2d(kernel_size=2)
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">p6_downsample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveMaxPool2d</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p7_downsample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Weight
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">p6_w1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p6_w1_relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p5_w1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p5_w1_relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p4_w1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p4_w1_relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p3_w1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p3_w1_relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p4_w2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p4_w2_relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p5_w2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p5_w2_relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p6_w2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p6_w2_relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p7_w2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p7_w2_relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="s">"""
            P7_0 -------------------------- P7_2 --------&gt;
            P6_0 ---------- P6_1 ---------- P6_2 --------&gt;
            P5_0 ---------- P5_1 ---------- P5_2 --------&gt;
            P4_0 ---------- P4_1 ---------- P4_2 --------&gt;
            P3_0 -------------------------- P3_2 --------&gt;
        """</span>

        <span class="c1"># P3_0, P4_0, P5_0, P6_0 and P7_0
</span>        <span class="n">p3_in</span><span class="p">,</span> <span class="n">p4_in</span><span class="p">,</span> <span class="n">p5_in</span><span class="p">,</span> <span class="n">p6_in</span><span class="p">,</span> <span class="n">p7_in</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="c1"># P7_0 to P7_2
</span>        <span class="c1"># Weights for P6_0 and P7_0 to P6_1
</span>        <span class="n">p6_w1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p6_w1_relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p6_w1</span><span class="p">)</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">p6_w1</span> <span class="o">/</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">p6_w1</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span>
        <span class="c1"># Connections for P6_0 and P7_0 to P6_1 respectively
</span>        <span class="n">p6_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv6_up</span><span class="p">(</span><span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">p6_in</span> <span class="o">+</span> <span class="n">weight</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">p6_upsample</span><span class="p">(</span><span class="n">p7_in</span><span class="p">))</span>
        <span class="c1"># Weights for P5_0 and P6_0 to P5_1
</span>        <span class="n">p5_w1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p5_w1_relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p5_w1</span><span class="p">)</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">p5_w1</span> <span class="o">/</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">p5_w1</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span>
        <span class="c1"># Connections for P5_0 and P6_0 to P5_1 respectively
</span>        <span class="n">p5_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv5_up</span><span class="p">(</span><span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">p5_in</span> <span class="o">+</span> <span class="n">weight</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">p5_upsample</span><span class="p">(</span><span class="n">p6_up</span><span class="p">))</span>
        <span class="c1"># Weights for P4_0 and P5_0 to P4_1
</span>        <span class="n">p4_w1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p4_w1_relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p4_w1</span><span class="p">)</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">p4_w1</span> <span class="o">/</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">p4_w1</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span>
        <span class="c1"># Connections for P4_0 and P5_0 to P4_1 respectively
</span>        <span class="n">p4_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv4_up</span><span class="p">(</span><span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">p4_in</span> <span class="o">+</span> <span class="n">weight</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">p4_upsample</span><span class="p">(</span><span class="n">p5_up</span><span class="p">))</span>

        <span class="c1"># Weights for P3_0 and P4_1 to P3_2
</span>        <span class="n">p3_w1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p3_w1_relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p3_w1</span><span class="p">)</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">p3_w1</span> <span class="o">/</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">p3_w1</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span>
        <span class="c1"># Connections for P3_0 and P4_1 to P3_2 respectively
</span>        <span class="n">p3_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv3_up</span><span class="p">(</span><span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">p3_in</span> <span class="o">+</span> <span class="n">weight</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">p3_upsample</span><span class="p">(</span><span class="n">p4_up</span><span class="p">))</span>

        <span class="c1"># Weights for P4_0, P4_1 and P3_2 to P4_2
</span>        <span class="n">p4_w2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p4_w2_relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p4_w2</span><span class="p">)</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">p4_w2</span> <span class="o">/</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">p4_w2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span>
        <span class="c1"># Connections for P4_0, P4_1 and P3_2 to P4_2 respectively
</span>        <span class="n">p4_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv4_down</span><span class="p">(</span>
            <span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">p4_in</span> <span class="o">+</span> <span class="n">weight</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">p4_up</span> <span class="o">+</span> <span class="n">weight</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">p4_downsample</span><span class="p">(</span><span class="n">p3_out</span><span class="p">))</span>
        <span class="c1"># Weights for P5_0, P5_1 and P4_2 to P5_2
</span>        <span class="n">p5_w2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p5_w2_relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p5_w2</span><span class="p">)</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">p5_w2</span> <span class="o">/</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">p5_w2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span>
        <span class="c1"># Connections for P5_0, P5_1 and P4_2 to P5_2 respectively
</span>        <span class="n">p5_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv5_down</span><span class="p">(</span>
            <span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">p5_in</span> <span class="o">+</span> <span class="n">weight</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">p5_up</span> <span class="o">+</span> <span class="n">weight</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">p5_downsample</span><span class="p">(</span><span class="n">p4_out</span><span class="p">))</span>
        <span class="c1"># Weights for P6_0, P6_1 and P5_2 to P6_2
</span>        <span class="n">p6_w2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p6_w2_relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p6_w2</span><span class="p">)</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">p6_w2</span> <span class="o">/</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">p6_w2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span>
        <span class="c1"># Connections for P6_0, P6_1 and P5_2 to P6_2 respectively
</span>        <span class="n">p6_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv6_down</span><span class="p">(</span>
            <span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">p6_in</span> <span class="o">+</span> <span class="n">weight</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">p6_up</span> <span class="o">+</span> <span class="n">weight</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">p6_downsample</span><span class="p">(</span><span class="n">p5_out</span><span class="p">))</span>
        <span class="c1"># Weights for P7_0 and P6_2 to P7_2
</span>        <span class="n">p7_w2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p7_w2_relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p7_w2</span><span class="p">)</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">p7_w2</span> <span class="o">/</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">p7_w2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span>
        <span class="c1"># Connections for P7_0 and P6_2 to P7_2
</span>        <span class="n">p7_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv7_down</span><span class="p">(</span><span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">p7_in</span> <span class="o">+</span> <span class="n">weight</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">p7_downsample</span><span class="p">(</span><span class="n">p6_out</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">p3_out</span><span class="p">,</span> <span class="n">p4_out</span><span class="p">,</span> <span class="n">p5_out</span><span class="p">,</span> <span class="n">p6_out</span><span class="p">,</span> <span class="n">p7_out</span>
</code></pre></div></div> <p>Please feel free to play around with the code in my <a href="https://github.com/WilsonFok2020/object-detection/">repository.</a></p> <h3 id="reference">Reference</h3> <p>Parts of the code are adapted from the following resources:</p> <ul> <li>https://lilianweng.github.io/lil-log/2018/12/27/object-detection-part-4.html</li> <li>https://www.jeremyjordan.me/object-detection-one-stage/</li> <li>https://github.com/signatrix/efficientdet</li> <li>http://pjreddie.com/yolo9000/</li> <li>https://github.com/yhenon/pytorch-retinanet</li> </ul> </div> <div id="disqus_thread"></div> </article> <script> var disqus_config = function () { this.page.url = "/deep_learning/2020/08/02/Learning_Object_Detection_part4/"; /* Replace PAGE_URL with your page's canonical URL variable */ this.page.identifier = "/deep_learning/2020/08/02/Learning_Object_Detection_part4"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */ }; (function () { /* DON'T EDIT BELOW THIS LINE */ var d = document, s = d.createElement('script'); s.src = 'https://.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a> </noscript></div> </div> <!-- End of row--> <div class="row"> <div class="col-md-4"> <div class="card"> <div class="card-header"> About </div> <div class="card-body"> <!-- Your Bio --> <p class="author_bio"> Hello, My name is Wilson Fok. I love to extract useful insights and knowledge from big data. Constructive feedback and insightful comments are very welcome!</p> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Categories </div> <div class="card-body text-dark"> <div id="#Finance"></div> <li class="tag-head"> <a href="/blog/categories/Finance">Finance</a> </li> <a name="Finance"></a> <div id="#NLP"></div> <li class="tag-head"> <a href="/blog/categories/NLP">NLP</a> </li> <a name="NLP"></a> <div id="#Deep_Learning"></div> <li class="tag-head"> <a href="/blog/categories/Deep_Learning">Deep_Learning</a> </li> <a name="Deep_Learning"></a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Useful Links </div> <div class="card-body text-dark"> <li > <a href="/about">About Me</a> </li> <li > <a href="/blog">Blog</a> </li> <li > <a href="/blog/categories">Categories</a> </li> <li > <a href="/contact">Contact Me</a> </li> </div> </div> </div> </div> </div> <footer> <p> Powered by Jekyll. Hosted on <a href="https://pages.github.com">Github</a>. Subscribe via <a href=" /feed.xml ">RSS <i class="fa fa-rss" aria-hidden="true"></i> </a> </p> </footer> </div> <script> var options = { classname: 'my-class', id: 'my-id' }; var nanobar = new Nanobar( options ); nanobar.go( 30 ); nanobar.go( 76 ); nanobar.go(100); </script> <!-- <div hidden id="snipcart" data-api-key="Y2I1NTAyNWYtMTNkMy00ODg0LWE4NDItNTZhYzUxNzJkZTI5NjM3MDI4NTUzNzYyMjQ4NzU0"></div> <script src="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.js" defer></script> --> <script src="/assets/js/mode-switcher.js"></script> </body> </html>
