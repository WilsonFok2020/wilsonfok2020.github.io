<!DOCTYPE html> <html lang=" en "><head> <meta charset="utf-8"> <title>Wilson Fok - A data science enthusiast</title> <meta http-equip="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="description" content="Classification Tasks - Improving the effectiveness of cross entropy loss by adding margin?" /> <meta name="keywords" content="Classification Tasks - Improving the effectiveness of cross entropy loss by adding margin?, Wilson Fok, Deep_Learning" /> <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml"> <meta content="" property="fb:app_id"> <meta content="Wilson Fok" property="og:site_name"> <meta content="Classification Tasks - Improving the effectiveness of cross entropy loss by adding margin?" property="og:title"> <meta content="article" property="og:type"> <meta content="This article reviews different attempts made to encourage better classification accuracy via loss functions." property="og:description"> <meta content="http://localhost:4000/deep_learning/2020/10/17/Classification-Tasks/" property="og:url"> <meta content="2020-10-17T00:00:00+08:00" property="article:published_time"> <meta content="http://localhost:4000/about/" property="article:author"> <meta content="http://localhost:4000/assets/img/posts//assets/images/classification_tasks/eg.png" property="og:image"> <meta content="Deep_Learning" property="article:section"> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@"> <meta name="twitter:creator" content="@"> <meta name="twitter:title" content="Classification Tasks - Improving the effectiveness of cross entropy loss by adding margin?"> <meta content="Wilson Fok" property="og:site_name"> <meta name="twitter:url" content="http://localhost:4000/deep_learning/2020/10/17/Classification-Tasks/"> <meta name="twitter:description" content="Hello, My name is Wilson Fok. I love to extract useful insights and knowledge from big data. I also like to make new friends and connections. Let's connect! "> <!-- load layout style css --> <link rel="stylesheet" href="/assets/css/main.css" /> <link rel="stylesheet" href="/assets/css/custom-style.css" /> <link rel="stylesheet" href="/assets/bower_components/lightgallery/dist/css/lightgallery.min.css"/> <link rel="stylesheet" href="/assets/bower_components/bootstrap/dist/css/bootstrap.min.css" /> <link rel="stylesheet" href="/assets/bower_components/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" /> <!-- Favicon --> <link rel="icon" href="http://localhost:4000/assets/img/favicon.ico" type="image/gif" sizes="16x16"> <!-- Jquery --> <!-- one or more of the below scripts does fancy word animation and dropdown menu --> <script src="/assets/extra_js/jquery-3.4.1.min.js"></script> <script src="/assets/extra_js/picturefill min/picturefill.min.js"></script> <script src="/assets/extra_js/instantsearch min/instantsearch.min.js"></script> <script src="/assets/extra_js/moment min/moment.min.js"></script> <script src="/assets/bower_components/jquery.easing/jquery.easing.min.js"></script> <script src="/assets/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script> <script src="/assets/bower_components/jquery-mousewheel/jquery.mousewheel.min.js"></script> <script src="/assets/bower_components/lightgallery/dist/js/lightgallery-all.min.js"></script> <script src="/assets/bower_components/imagesloaded/imagesloaded.pkgd.min.js"></script> <script src="/assets/bower_components/nanobar/nanobar.min.js"></script> <script src="/assets/bower_components/typewrite/dist/typewrite.min.js"></script> </head><body> <div class="container-fluid"><header> <script src="https://cdn.knightlab.com/libs/juxtapose/latest/js/juxtapose.min.js"></script> <link rel="stylesheet" href="https://cdn.knightlab.com/libs/juxtapose/latest/css/juxtapose.css"> <div class="col-lg-12"> <div class="row"> <nav class="navbar navbar-expand-lg fixed-top navbar-dark " id="topNav"> <!-- <a class="navbar-brand" href="#">Wilson Fok</a> --> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="/">Wilson Fok</a> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav"> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/about">About Me</a> </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/blog">Blog</a> </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/blog/categories">Categories</a> </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/gallery">Gallery</a> </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/contact">Contact Me</a> </li> </ul> </div> <ul class="nav justify-content-end"> <!-- <li class="nav-item"> <a class="nav-link" id="search-icon" href="http://localhost:4000/search/"><i class="fa fa-search" aria-hidden="true"></i></a> </li> --> <li class="nav-item"> <input class="nav-link switch" id="theme-toggle" onclick="modeSwitcher() "type="checkbox" name="checkbox" > </li> </ul> </nav> </div> </div> </header><div class="col-lg-12"> <!-- Blog Post Breadcrumbs --><div class="col-lg-12"> <nav aria-label="breadcrumb" role="navigation"> <ol class="breadcrumb"> <li class="breadcrumb-item"> <a href="http://localhost:4000/blog"><i class="fa fa-home" aria-hidden="true"></i></a> </li> <li class="breadcrumb-item active" aria-current="page"><a href="/deep_learning/2020/10/17/Classification-Tasks/">Classification Tasks - Improving the effectiveness of cross entropy loss by adding margin?</a></li> </ol> </nav> </div><div class="row" id="blog-post-container"> <div class="col-lg-8 offset-md-2"><article class="card" itemscope itemtype="http://schema.org/BlogPosting"> <div class="card-header"> <h1 class="post-title" itemprop="name headline">Classification Tasks - Improving the effectiveness of cross entropy loss by adding margin?</h1> <p></p> <h6 class="post-meta"> <i> Summary : This article reviews different attempts made to encourage better classification accuracy via loss functions.</i> </h6> <p class="post-summary">Posted by : <img src="http://localhost:4000/assets/img/profile.png" class="author-profile-img"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name">Wilson Fok</span> </span> on <time datetime="2020-10-17 00:00:00 +0800" itemprop="datePublished">Oct 17, 2020</time> </p> <span class="disqus-comment-count" data-disqus-identifier="/deep_learning/2020/10/17/Classification-Tasks/"></span> <div class="post-categories"> Category : <a href="/blog/categories/Deep_Learning">Deep_Learning</a> </div> </div> <div class="card-body" itemprop="articleBody"> <h3 id="motivation">Motivation</h3> <p>Grouping similar samples and separating dissimilar samples are an integral challenge for image recognition such as face recognition and for information retrieval tasks such as image query and retrieval.</p> <p>The difficulty is compounded when the number of classes are infinite. For instance, there are countless numbers of word phrases people can use to search for an item (depicted by 2D images) or a vastly greater number of photos that do not belong to a single person than his or her photos while the same person could look quite different in his or her photo albums. In the former situation, the number of classes in a classifier cannot be set and trained in advance. In the latter situation, the number of pairs or number of cases would be humongous for any classifier to work with.</p> <h3 id="background">Background</h3> <p>To classify anything, a model needs to identify relevant features and compare these features of the present item to those it has seen before. Based on some sort of similar metric, the model puts a label on the present item in relation to others it has seen before. In other words, classification of an image as cat means that the image has shown features more similar to images that are labeled cat than images that are labeled dog during training.</p> <p>The model relies on feature extract ( such as Convolutional Neural Network that transforms inputs to vectors) to identify relevant features while it relies on a classifier to predict labels.</p> <p>Because this article is about loss margin that works on classifier, we will leave the discussion of feature extractor out.</p> <p>Classifiers come in many shapes or forms. Common ones include k-nearest neightbor (kNN), extended nearest neighbnor (ENN), support vector machine, linear classifier, logistic regression, decision tree / random forest, so on and so forth. But what does a classifier really do? To explain its role, I take support vector machine as an example to illustrate what a linear classifier does. (of course, here we assume to have chosen a linear kernel for support vector machine rather than radial basis or polynomial kernels. Otherwise, the decision boundary couldn’t be a simple straight line on a diagram).</p> <p>The black and red colors represent two different classes. Here a single dot denotes a single training sample. The blank space depicts a vector space / embedding space into which a feature extractor has transformed the input.</p> <p>The solid straight line represents a hyperplane. Depending on which side of the hyperplane a sample falls on, the classifier assigns either black or red class labels.</p> <p>The dotted boundaries enclose the margin, a space that we want to widen without harming the accuracy of the classifier. In support vector machine, the points (drawn as stars) which define the margin or decision boundary are selected from training set and thus are known as support vectors.</p> <p>When a classifier predicts a sample wrongly, the sample (dots with a green ring) falls on the wrong side of the decision boundary.</p> <p><img src="/assets/images/classification_tasks/svm.png" alt="Picture description" width="1100px" /></p> <center> <a href="https://www.sciencedirect.com/topics/engineering/support-vector-machine"> Linear SVM </a> </center> <p></p> <p>With that, we can also re-examine the same situation through the lens of probability.</p> <p>The probability value is calculated by the distance a sample sits away from the decision boundary. Such distance captures the notation that some samples are more different to others.</p> <p>With a toy example, Scikit learn has provided a very intuitive plot of the predicted probability assigned to each class for each sample.</p> <p><img src="/assets/images/classification_tasks/eg.png" alt="Picture description" width="1100px" /></p> <center> <a href="https://scikit-learn.org/stable/auto_examples/classification/plot_classification_probability.html"> plot_classification_probability </a> </center> <p></p> <p>This example examine 5 different classifiers, namely support vector machine, L1 and L2 penalized logistic regression with either a One-Vs-Rest or multinomial setting, and Gaussian process classification. The magnitude of the probability is shown by the color-bar at the bottom. The steepness or the rate of change of the probability at the decision boundary depends on the classifier and constraints. It is interesting to see that L2 logistic (OVR) uses a less precipitous boundary than others of the same categories. Nonetheless, they tend to extrapolate the likelihood even when there is no evidence or samples (see the bright yellow at far corners). The exception is Gaussian process which decays the probability as the distance from samples rises.</p> <p>In addition, a common consensus is that learning ought to minimize intra-class variance and maximize inter-class variation. In other words, those belonging to one class should be tightly packed. Those coming from different classes should be well-dispersed.</p> <p>Now we have seen what the decision boundary conceptually looks like and how it works in prediction or in probabilities terms. We are interested in enforcing this margin at the boundary. To do so is no easy task for a convolutional neural network because we typically use cross-entropy loss. The trouble is that cross-entropy loss does not guarantee that the model, upon convergence after optimization uses a decision boundary supported by a wide margin.</p> <p>To illustrate this point, we take a look at:</p> <p><img src="/assets/images/classification_tasks/arcFace.png" alt="Picture description" width="1100px" /></p> <center> From ArcFace: Additive Angular Margin Loss for Deep Face Recognition. Source: <a href="https://github.com/deepinsight/insightface "> Github repository </a> </center> <p></p> <p>Here is another illustration on the same point.</p> <p><img src="/assets/images/classification_tasks/cosFace.png" alt="Picture description" width="1100px" /></p> <center> From <a href="https://arxiv.org/abs/1801.09414"> CosFace: Large Margin Cosine Loss for Deep Face Recognition </a> </center> <p></p> <p>In both Figure 2 and 5, softmax represents cross entropy loss. There is no margin between the two classes (blue and green). It is even possible for the two classes to overlap (negative margin).</p> <p>SphereFace or angular softmax (A-Softmax) creates a decision boundary that is a function of the angle. As we rotate in this space, the gap between the two classes varies. However, this variability is considered by some to be less than ideal. SphereFace, first published in this paper: SphereFace: Deep Hypersphere Embedding for Face Recognition, aims to spread the two classes on a sphere. The authors use a toy example to show how to control the spread via a parameter m. By tuning the parameter m, the authors encourage the model to clusters the samples in very well-separated blobs.</p> <p>Anecdotal evidence: I have tried SphereFace several times before, but my experience suggests that it seems harder for some models to converge.</p> <p><img src="/assets/images/classification_tasks/sphereface.png" alt="Picture description" width="1100px" /></p> <center> From <a href="https://www.arxiv-vanity.com/papers/1704.08063"> SphereFace: Deep Hypersphere Embedding for Face Recognition </a> </center> <p></p> <p>ArcFace, CosFace and Large margin cosine loss (LMCL) are very similar.</p> <p>Large margin cosine loss (LMCL) represents CosFace. The margin comes in the form of angle, theta, between the two classes. CosFace removes radial variation by normalizing features and weights vectors (L2 norm). The authors have shown that without doing this normalization, the predicted posterior probability would depend on the norm of features and weights and may result in the undesirable overlap in softmax! Here is the author’s own words.</p> <p><img src="/assets/images/classification_tasks/3.png" alt="Picture description" /></p> <p>There are several things worth pointing out. By setting the norm of Wj to 1, we take W out of the equation. By setting the norm of x to s, we simply rescale the logits by s to satisfy equation 3.</p> <p>However, this formulation does not provide the needed margin. To add the margin, m, we simply</p> <p><img src="/assets/images/classification_tasks/5.png" alt="Picture description" /></p> <p>It may seem counter-intuitive to see the authors use minus m when we are trying to “add” margin. The way I understand this is by thinking it through a sequence of logical steps. The problem is minimization; we try to minimize the network loss or negative log likelihood. This act is equivalent to maximizing the posterior probability of the correct classes. To add a margin means to have one class be at least m greater than another class. Therefore, we need to minus m to encourage the model to create a margin that is at least m wide during maximization.</p> <p>The margin looks like this: <img src="/assets/images/classification_tasks/margin.png" alt="Picture description" width="1100px" /></p> <center> <a href="https://arxiv.org/abs/1801.09414"> CosFace: Large Margin Cosine Loss for Deep Face Recognition </a> </center> <p></p> <p>Like CosFace, ArcFace (shown below) also adds a margin m.</p> <p><img src="/assets/images/classification_tasks/framework.png" alt="Picture description" width="1100px" /></p> <center> <a href="https://github.com/deepinsight/insightface "> ArcFace: Additive Angular Margin Loss for Deep Face Recognition </a> </center> <p></p> <p>To really compare and contrast SphereFace, CosFace and ArcFace, we need to take a closer look at the maths: <img src="/assets/images/classification_tasks/eq.png" alt="Picture description" width="1100px" /></p> <p>SphereFace uses m1. ArcFace uses m2. CosFace uses m3.</p> <h3 id="performances">Performances</h3> <p>Based on the results of multiple tests in the paper, I think they all perform equally well. <img src="/assets/images/classification_tasks/results.png" alt="Picture description" width="1100px" /></p> <h3 id="python-implementation">Python Implementation</h3> <p>The official implementation in Pytorch of the above margin losses can be found in the <a href="https://github.com/ronghuaiyang/arcface-pytorch">author’s repository </a>.</p> <p>I would like to take a closer look at their implementation, specifically, arcMargin, addMargin, sphereProduct.</p> <h4 id="arcmarginproduct">ArcMarginProduct:</h4> <p><img src="/assets/images/classification_tasks/arcmarginproduct.png" alt="Picture description" width="1100px" /> *Line 26: we initialize the weight, W, matrix as the linear classifier *Line 30-33: we convert angle to “geometrical” distance *Line 36: we normalize the embedding and W to a norm value of 1. Thus, we calculate equation 5 in the previous section. *Line 38: we use Pythagoras Theorem to calculate the length. *Line 39-43: this is almost the margin. If the angle is greater than 0 or phi, we update the margin. *Line 49-50: rescale original logit.</p> <h4 id="addmarginproduct">AddMarginProduct:</h4> <p><img src="/assets/images/classification_tasks/addmarginproduct.png" alt="Picture description" width="1100px" /> Line 78: unlike ArcMargin, we only care about the angle here.</p> <h3 id="how-to-quantify-embedding-quality">How to quantify embedding quality?</h3> <p>While I comprehend why the authors go straight to test accuracy as a measure to demonstrate the effectiveness of each loss reformulation, test accuracy may not tell us the whole story even though the quality of the embedding is just a means to an end.</p> <p>Anyway, I think we could also try to use silhouette score to quantify the goodness of the shape of the groups of samples of the classes in the embedding space.</p> <p>Here is a quote from scikit learn page on silhouette score</p> <blockquote> <p>Compute the mean Silhouette Coefficient of all samples. The Silhouette Coefficient is calculated using the mean intra-cluster distance (a) and the mean nearest-cluster distance (b) for each sample. The Silhouette Coefficient for a sample is (b - a) / max(a, b). To clarify, b is the distance between a sample and the nearest cluster that the sample is not a part of. Note that Silhouette Coefficient is only defined if number of labels is 2 &lt;= n_labels &lt;= n_samples - 1. This function returns the mean Silhouette Coefficient over all samples. To obtain the values for each sample, use silhouette_samples. The best value is 1 and the worst value is -1. Values near 0 indicate overlapping clusters. Negative values generally indicate that a sample has been assigned to the wrong cluster, as a different cluster is more similar.</p> </blockquote> <p>From my experience, the real-world is not as clean as the textbook, higher silhouette score may not necessarily lead to better accuracy.</p> </div> <div id="disqus_thread"></div> </article> <script> var disqus_config = function () { this.page.url = "http://localhost:4000/deep_learning/2020/10/17/Classification-Tasks/"; /* Replace PAGE_URL with your page's canonical URL variable */ this.page.identifier = "/deep_learning/2020/10/17/Classification Tasks"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */ }; (function () { /* DON'T EDIT BELOW THIS LINE */ var d = document, s = d.createElement('script'); s.src = 'https://.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a> </noscript></div> </div> <!-- End of row--> <div class="row"> <div class="col-md-4"> <div class="card"> <div class="card-header"> About </div> <div class="card-body"> <!-- Your Bio --> <p class="author_bio"> Hello, My name is Wilson Fok. I love to extract useful insights and knowledge from big data. Constructive feedback and insightful comments are very welcome!</p> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Categories </div> <div class="card-body text-dark"> <div id="#Finance"></div> <li class="tag-head"> <a href="/blog/categories/Finance">Finance</a> </li> <a name="Finance"></a> <div id="#NLP"></div> <li class="tag-head"> <a href="/blog/categories/NLP">NLP</a> </li> <a name="NLP"></a> <div id="#Deep_Learning"></div> <li class="tag-head"> <a href="/blog/categories/Deep_Learning">Deep_Learning</a> </li> <a name="Deep_Learning"></a> <div id="#Others"></div> <li class="tag-head"> <a href="/blog/categories/Others">Others</a> </li> <a name="Others"></a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Useful Links </div> <div class="card-body text-dark"> <li > <a href="http://localhost:4000/about">About Me</a> </li> <li > <a href="http://localhost:4000/blog">Blog</a> </li> <li > <a href="http://localhost:4000/blog/categories">Categories</a> </li> <li > <a href="http://localhost:4000/gallery">Gallery</a> </li> <li > <a href="http://localhost:4000/contact">Contact Me</a> </li> </div> </div> </div> </div> </div> <footer> <p> Powered by Jekyll. Hosted on <a href="https://pages.github.com">Github</a>. Subscribe via <a href=" /feed.xml ">RSS <i class="fa fa-rss" aria-hidden="true"></i> </a> </p> </footer> </div> <script> var options = { classname: 'my-class', id: 'my-id' }; var nanobar = new Nanobar( options ); nanobar.go( 30 ); nanobar.go( 76 ); nanobar.go(100); </script> <!-- <div hidden id="snipcart" data-api-key="Y2I1NTAyNWYtMTNkMy00ODg0LWE4NDItNTZhYzUxNzJkZTI5NjM3MDI4NTUzNzYyMjQ4NzU0"></div> <script src="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.js" defer></script> --> <script src="/assets/js/mode-switcher.js"></script> </body> </html>
